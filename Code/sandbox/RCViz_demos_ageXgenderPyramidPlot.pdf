
###########################################################################################
# packages and data
###########################################################################################

library(tidyverse)
library(lubridate, warn.conflicts = FALSE)
library(fmsb)
library(dplyr)
library(patchwork)
library(ggplotify)

dat <- read.csv("/Users/tg625/Downloads/LC-Allvariable_2024-06-10_1544.csv")

################################
# data wrangling
################################
#gender - 2 NA (?)

x <- dat %>%
  dplyr::filter(!grepl("TEST", record_id)) %>%
  filter(!record_id == "1") %>%
  mutate(identified_gender=case_when(identified_gender == "1" ~ "Male",
                                     identified_gender == "2" ~ "Female")) %>%
  select(record_id, identified_gender, date_of_birth) %>%
  drop_na() %>%
  mutate(DOB=lubridate::as_date(date_of_birth)) %>%
  mutate(age=lubridate::interval(DOB, lubridate::now()) / years(1)) %>%
  mutate(ageGroups = case_when(age > 16 & age < 21 ~ "16-21yrs",
                               age > 21 & age < 25 ~ "22-26yrs",
                               age > 25 & age < 30 ~ "27-31yrs",
                               age > 30 & age < 36 ~ "32-35yrs")) %>%
  group_by(identified_gender, ageGroups) %>%
  summarise(pop = n(), frac = pop / nrow(.))

nudge_fun <- function(df) {
  ifelse(df$identified_gender == "Male", (sd(df$pop) / 3) * - 1, sd(df$pop) / 3)
}

xlimits <- c((length(x2$identified_gender)) * -1, length(x2$identified_gender))

x2 <- x %>%
  mutate(
         pop = ifelse(identified_gender == "Male", pop * (-1), pop * 1),
         frac = ifelse(identified_gender == "Male", frac * (-1), frac * 1),
         share = paste0(abs(round(frac * 100, 1)), "%"),
         identified_gender = as.factor(identified_gender))

######################
#make plot
######################

ageXgenderPyramidplot<-x2 %>%  ggplot(data = ., aes(x = pop, y = ageGroups, label = share)) +
  geom_col(aes(fill = identified_gender)) +
  geom_text(aes(label = share),
            position = position_nudge(x = nudge_fun(x2)),
            size = 4) +
  geom_vline(xintercept = 0, linetype = "dotted",
             color = "black", size = 1.5) +
  scale_fill_manual("", values = c("#990099", "#009900")) +
  scale_x_continuous("", breaks = scales::pretty_breaks(n = 6),
    labels = function(br) {
      ifelse(abs(br) >= 1000,
             paste0(abs(br) / 1000, "k"),
             abs(br))
    }
  ) +
  labs(x = "No. of people", y = "Age") +
  xlim(xlimits) +
  theme_classic() +
  theme(legend.position = 'bottom',
        axis.title.x = element_blank())

######################
#save plot
######################

  ggsave(ageXgenderPyramidplot, filename="ageXgenderPyramidplot.pdf")

